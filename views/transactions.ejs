<%- include('layout', { body: `
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-list-ul"></i> Transactions</h2>
    <div>
        <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#importModal">
            <i class="bi bi-upload"></i> Import CSV
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">
            <i class="bi bi-plus-lg"></i> Add Transaction
        </button>
    </div>
</div>

<!-- Filter -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Filter by Category</label>
                <select name="category" class="form-select">
                    <option value="">All Categories</option>
                    ${categories.map(c => `<option value="${c}" ${selectedCategory === c ? 'selected' : ''}>${c}</option>`).join('')}
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-outline-primary">
                    <i class="bi bi-filter"></i> Filter
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Transactions Table -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Category</th>
                        <th>Merchant</th>
                        <th>Amount</th>
                        <th>Payment</th>
                        <th>Risk</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    ${transactions.length > 0 ? transactions.map(t => `
                        <tr>
                            <td>${new Date(t.date).toLocaleDateString()}</td>
                            <td><span class="badge bg-secondary">${t.category}</span></td>
                            <td>${t.merchant}</td>
                            <td class="fw-bold">₹${t.amount.toLocaleString()}</td>
                            <td><small>${t.payment_method}</small></td>
                            <td>
                                <span class="badge bg-${t.risk_level === 'Critical' ? 'danger' : t.risk_level === 'High' ? 'warning' : t.risk_level === 'Medium' ? 'info' : 'success'}">
                                    ${t.risk_level}
                                </span>
                            </td>
                            <td>
                                <form method="POST" action="/transactions/${t.id}?_method=DELETE" class="d-inline" onsubmit="return confirm('Delete this transaction?')">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                    `).join('') : `
                        <tr>
                            <td colspan="7" class="text-center py-4 text-muted">
                                <i class="bi bi-inbox fs-1"></i>
                                <p class="mt-2">No transactions yet</p>
                            </td>
                        </tr>
                    `}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
${totalPages > 1 ? `
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="?page=${currentPage - 1}${selectedCategory ? '&category=' + selectedCategory : ''}">Previous</a>
        </li>
        ${Array.from({length: totalPages}, (_, i) => i + 1).map(p => `
            <li class="page-item ${p === currentPage ? 'active' : ''}">
                <a class="page-link" href="?page=${p}${selectedCategory ? '&category=' + selectedCategory : ''}">${p}</a>
            </li>
        `).join('')}
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="?page=${currentPage + 1}${selectedCategory ? '&category=' + selectedCategory : ''}">Next</a>
        </li>
    </ul>
</nav>
` : ''}

<!-- Add Transaction Modal -->
<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/transactions">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Add Transaction</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Amount *</label>
                        <div class="input-group">
                            <span class="input-group-text">₹</span>
                            <input type="number" name="amount" class="form-control" required min="1" step="0.01">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category *</label>
                        <select name="category" class="form-select" required>
                            ${categories.map(c => `<option value="${c}">${c}</option>`).join('')}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Merchant</label>
                        <input type="text" name="merchant" class="form-control" placeholder="Store name">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" name="description" class="form-control" placeholder="Notes">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Payment Method</label>
                            <select name="payment_method" class="form-select">
                                ${paymentMethods.map(p => `<option value="${p}">${p}</option>`).join('')}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Date *</label>
                            <input type="date" name="date" class="form-control" required value="${new Date().toISOString().split('T')[0]}">
                        </div>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" name="is_recurring" class="form-check-input" id="recurring">
                        <label class="form-check-label" for="recurring">Recurring expense</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Transaction</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Import CSV Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="/transactions/import" enctype="multipart/form-data" id="csvImportForm">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-file-earmark-spreadsheet"></i> Import Transactions from CSV</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Drag and Drop Zone -->
                    <div id="dropZone" class="border border-2 border-dashed rounded p-5 text-center mb-3" style="cursor: pointer; transition: all 0.3s ease;">
                        <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                        <p class="mt-2 mb-1">Drag and drop your CSV file here</p>
                        <p class="text-muted small">or click to browse</p>
                        <input type="file" name="csvFile" id="csvFileInput" accept=".csv" class="d-none" required>
                    </div>

                    <!-- Selected File Display -->
                    <div id="selectedFile" class="alert alert-info d-none">
                        <i class="bi bi-file-earmark-check"></i>
                        <span id="fileName"></span>
                        <button type="button" class="btn-close float-end" onclick="clearFile()"></button>
                    </div>

                    <!-- CSV Format Help -->
                    <div class="alert alert-secondary">
                        <h6><i class="bi bi-info-circle"></i> CSV Format Requirements</h6>
                        <p class="small mb-2">Your CSV file should have these columns (required fields marked with *):</p>
                        <ul class="small mb-0">
                            <li><strong>date*</strong> - Transaction date (YYYY-MM-DD format preferred)</li>
                            <li><strong>amount*</strong> - Transaction amount (numeric)</li>
                            <li><strong>category*</strong> - Category name (e.g., Food & Dining, Shopping, etc.)</li>
                            <li><strong>merchant</strong> - Store/vendor name (optional)</li>
                            <li><strong>description</strong> - Notes (optional)</li>
                            <li><strong>payment_method</strong> - UPI, Credit Card, Debit Card, Cash, Net Banking (optional)</li>
                            <li><strong>is_recurring</strong> - 1 or true for recurring expenses (optional)</li>
                        </ul>
                    </div>

                    <!-- Sample CSV Preview -->
                    <details class="mb-0">
                        <summary class="text-primary small" style="cursor: pointer;">View sample CSV format</summary>
                        <pre class="bg-dark text-light p-2 rounded mt-2 small">date,amount,category,merchant,description,payment_method
2024-01-15,500,Food & Dining,Swiggy,Lunch order,UPI
2024-01-16,2500,Shopping,Amazon,Electronics,Credit Card
2024-01-17,150,Transportation,Uber,Office commute,UPI</pre>
                    </details>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="importBtn" disabled>
                        <i class="bi bi-upload"></i> Import Transactions
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Drag and Drop functionality
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('csvFileInput');
const selectedFile = document.getElementById('selectedFile');
const fileName = document.getElementById('fileName');
const importBtn = document.getElementById('importBtn');

// Click to browse
dropZone.addEventListener('click', () => fileInput.click());

// Drag events
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-primary', 'bg-primary', 'bg-opacity-10');
});

dropZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-primary', 'bg-primary', 'bg-opacity-10');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-primary', 'bg-primary', 'bg-opacity-10');

    const files = e.dataTransfer.files;
    if (files.length > 0 && files[0].name.endsWith('.csv')) {
        fileInput.files = files;
        showSelectedFile(files[0]);
    } else {
        alert('Please drop a CSV file');
    }
});

// File input change
fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        showSelectedFile(e.target.files[0]);
    }
});

function showSelectedFile(file) {
    fileName.textContent = file.name + ' (' + formatFileSize(file.size) + ')';
    selectedFile.classList.remove('d-none');
    dropZone.classList.add('d-none');
    importBtn.disabled = false;
}

function clearFile() {
    fileInput.value = '';
    selectedFile.classList.add('d-none');
    dropZone.classList.remove('d-none');
    importBtn.disabled = true;
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// Form submission loading state
document.getElementById('csvImportForm').addEventListener('submit', function() {
    importBtn.disabled = true;
    importBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Importing...';
});
</script>
`, title: 'Transactions', active: 'transactions' }) %>
